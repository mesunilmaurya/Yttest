<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Player - Fix Playback</title>
    <style>
        body { background: #121212; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        /* Search Area */
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; width: 100%; max-width: 600px; }
        input { flex: 1; padding: 12px; border-radius: 4px; border: 1px solid #333; background: #222; color: white; font-size: 16px; outline: none; }
        button { padding: 12px 24px; background: #cc0000; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 16px; }
        button:hover { background: #ff0000; }
        
        /* Player Area */
        #player-container { width: 100%; max-width: 600px; aspect-ratio: 16/9; background: black; margin-bottom: 10px; border: 1px solid #333; }
        
        /* Debug / Status Log */
        .status-box { width: 100%; max-width: 600px; background: #000; border: 1px solid #444; padding: 10px; height: 150px; overflow-y: scroll; font-family: monospace; font-size: 12px; color: #00ff00; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #222; }
        .error-entry { color: #ff4444; }
    </style>
</head>
<body>

    <h2>YouTube API Playlist Test</h2>
    
    <div class="search-box">
        <input type="text" id="query" placeholder="Enter topic (e.g. 'NCS Music')" value="NCS Music">
        <button id="btn-play" onclick="startProcess()">Load & Play</button>
    </div>

    <div id="player-container">
        <div id="player"></div>
    </div>

    <div class="status-box" id="debug-log">
        <div class="log-entry">Waiting for user...</div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
        // YOUR KEY
        const MY_KEY = 'AIzaSyDf9K1gK2yR0ELuWrB2vBJpxgzL7ox8ogQ';
        let player;
        let isPlayerReady = false;

        // 1. Logger Function (Prints to the black box)
        function log(msg, isError = false) {
            const box = document.getElementById('debug-log');
            const div = document.createElement('div');
            div.className = isError ? 'log-entry error-entry' : 'log-entry';
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            box.prepend(div); // Add to top
            console.log(msg);
        }

        // 2. Initialize Player
        function onYouTubeIframeAPIReady() {
            log("API Loaded. Creating Player...");
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                playerVars: { 
                    'autoplay': 1, 
                    'controls': 1,
                    'origin': window.location.origin // Fixes some embedding blocks
                },
                events: {
                    'onReady': onPlayerReady,
                    'onError': onPlayerError,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            isPlayerReady = true;
            log("Player is READY. You can now click Search.");
        }

        function onPlayerError(event) {
            let errorMsg = "Unknown Error";
            if (event.data === 2) errorMsg = "Invalid Parameter";
            if (event.data === 100) errorMsg = "Video Not Found (Removed/Private)";
            if (event.data === 101 || event.data === 150) errorMsg = "Playback Blocked by Owner (Copyright)";
            
            log(`PLAYER ERROR ${event.data}: ${errorMsg}`, true);
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING) log("State: PLAYING");
            if (event.data === YT.PlayerState.BUFFERING) log("State: BUFFERING");
            if (event.data === YT.PlayerState.CUED) log("State: CUED (Ready to play)");
        }

        // 3. Main Logic
        async function startProcess() {
            const q = document.getElementById('query').value.trim();
            if(!isPlayerReady) return alert("Player not ready yet. Wait a second.");
            
            log(`Starting Search for: ${q}...`);

            try {
                // FETCH DATA
                const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(q)}&key=${MY_KEY}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.error) {
                    log(`API Error: ${data.error.message}`, true);
                    return;
                }

                if (!data.items || data.items.length === 0) {
                    log("No videos found.", true);
                    return;
                }

                // EXTRACT IDs
                const videoIds = data.items.map(item => item.id.videoId);
                log(`Found ${videoIds.length} videos. IDs: ${videoIds.join(', ')}`);

                // LOAD PLAYLIST
                // We use 'loadPlaylist' to force the queue UI
                log("Sending 'loadPlaylist' command to player...");
                
                player.loadPlaylist({
                    playlist: videoIds,
                    index: 0,
                    startSeconds: 0
                });

            } catch (e) {
                log(`Network Error: ${e.message}`, true);
            }
        }
    </script>
</body>
</html>
